// –ù–∞–≤–∏–≥–∞—Ü–∏—è
const sections = {
    home: document.getElementById('home'),
    game: document.getElementById('game'),
    rules: document.getElementById('rules'),
    teacher: document.getElementById('teacher')
};

function toggleSections(show){
    for(let k in sections) sections[k].classList.add('hidden');
    sections[show].classList.remove('hidden');
}
function showHome(){ toggleSections('home'); resetGame(); }
function showRules(){ toggleSections('rules'); }
function startGame(){ toggleSections('game'); initBoard(); }
function showTeacher(){ toggleSections('teacher'); }

// –î—ã–±—ã—Å—Ç–∞—Ä
const correctSound = new Audio('sounds/correct.mp3');
const wrongSound = new Audio('sounds/wrong.mp3');
const moveSound = new Audio('sounds/move.mp3');
const captureSound = new Audio('sounds/capture.mp3');

// –û–π—ã–Ω –ª–æ–≥–∏–∫–∞—Å—ã
let boardState=[], selectedPiece=null;

// üîπ 20+20 —Å“±—Ä–∞“õ (–±–∞—Ä–ª—ã“õ —à–∞—à–∫–∞“ì–∞)
const questions = [
  {piece:'W1', question:'¬´–ú–µ–Ω –±–∞—Ä–∞–º—ã–Ω, ‚Ä¶ —Å–µ–Ω “Ø–π–¥–µ “õ–∞–ª–∞—Å—ã“£¬ª ‚Äì –¥“±—Ä—ã—Å —à—ã–ª–∞—É?', options:['–±—ñ—Ä–∞“õ','–∂”ô–Ω–µ','–Ω–µ–º–µ—Å–µ'], answer:'–±—ñ—Ä–∞“õ'},
  {piece:'W2', question:'¬´–û–ª –∫—ñ—Ç–∞–ø –æ“õ–∏–¥—ã, ‚Ä¶ —Å–∞–±–∞“õ“õ–∞ –¥–∞–π—ã–Ω–¥–∞–ª–∞–¥—ã¬ª ‚Äì –¥“±—Ä—ã—Å —à—ã–ª–∞—É?', options:['–∂”ô–Ω–µ','–Ω–µ–º–µ—Å–µ','–±—ñ—Ä–∞“õ'], answer:'–∂”ô–Ω–µ'},
  {piece:'W3', question:'¬´–°–µ–Ω –æ“õ—ã–¥—ã“£ –±–∞, ‚Ä¶ –º–µ–Ω –¥–µ –æ“õ—ã–¥—ã–º¬ª ‚Äì –¥“±—Ä—ã—Å —à—ã–ª–∞—É?', options:['–¥–µ','–ø–∞','–º–µ'], answer:'–¥–µ'},
  // ‚Ä¶ –±–∞—Ä–ª—ã“õ —à–∞—à–∫–∞“ì–∞ —Å“±—Ä–∞“õ—Ç–∞—Ä –æ—Å—ã–ª–∞–π –∂–∞–ª“ì–∞—Å–∞–¥—ã
];

// üîπ –¢–∞“õ—Ç–∞ “õ“±—Ä—É –∂”ô–Ω–µ —à–∞—à–∫–∞ –æ—Ä–Ω–∞–ª–∞—Å—Ç—ã—Ä—É
function initBoard(){
    const board = document.getElementById('board');
    board.innerHTML='';
    boardState = Array(64).fill(null);
    const whiteStart=[1,3,5,7,8,10,12,14,17,19,21,23];
    const blackStart=[40,42,44,46,49,51,53,55,56,58,60,62];
    whiteStart.forEach((i,j)=>placePiece(i,'white','W'+(j+1)));
    blackStart.forEach((i,j)=>placePiece(i,'black','B'+(j+1)));
    enableDragDrop();
}

function placePiece(index,color,id){
    const cell=document.querySelector(`.cell[data-index='${index}']`);
    const piece=document.createElement('div');
    piece.classList.add('piece',color);
    piece.id=id;
    piece.draggable = true;
    cell.appendChild(piece);
    boardState[index]=id;
}

let dragSourceIndex = null;
function enableDragDrop(){
    document.querySelectorAll('.piece').forEach(p=>{
        p.addEventListener('dragstart', e=>{
            dragSourceIndex = [...document.querySelectorAll('.cell')].findIndex(c=>c.contains(e.target));
        });
    });
    document.querySelectorAll('.cell').forEach(cell=>{
        cell.addEventListener('dragover', e=> e.preventDefault());
        cell.addEventListener('drop', e=>{
            if(dragSourceIndex===null) return;
            const targetIndex = [...document.querySelectorAll('.cell')].indexOf(cell);
            const pieceId = boardState[dragSourceIndex];
            if(!pieceId) return;
            showQuestionForPiece(pieceId,targetIndex);
            dragSourceIndex=null;
        });
    });
}

function showQuestionForPiece(pieceId,targetIndex){
    const q = questions.find(q=>q.piece===pieceId);
    if(!q){ movePiece(pieceId,targetIndex); return; }

    const qt=document.getElementById('question-text');
    const ansDiv=document.getElementById('answers');
    qt.textContent=q.question;
    ansDiv.innerHTML='';
    q.options.forEach(opt=>{
        const btn=document.createElement('button');
        btn.textContent=opt;
        btn.onclick=()=>checkAnswer(opt,q.answer,pieceId,targetIndex);
        ansDiv.appendChild(btn);
    });
}

function checkAnswer(selected,correct,pieceId,targetIndex){
    if(selected===correct){ correctSound.play(); movePiece(pieceId,targetIndex); }
    else{ wrongSound.play(); alert('“ö–∞—Ç–µ –∂–∞—É–∞–ø!'); }
}

function movePiece(id,targetIndex){
    const oldIndex = boardState.findIndex(p=>p===id);
    if(boardState[targetIndex]){
        document.getElementById(boardState[targetIndex]).remove();
        captureSound.play();
    }
    const oldCell=document.querySelector(`.cell[data-index='${oldIndex}']`);
    oldCell.innerHTML='';
    const color = id[0]==='W'?'white':'black';
    placePiece(targetIndex,color,id);
    moveSound.play();
    selectedPiece=null;
    checkWinner();
}

function checkWinner(){
    const whiteLeft = document.querySelectorAll('.piece.white').length;
    const blackLeft = document.querySelectorAll('.piece.black').length;
    if(whiteLeft===0 || blackLeft===0){
        document.getElementById('winner').classList.remove('hidden');
        document.getElementById('winner').textContent = whiteLeft===0 ? '“ö–∞—Ä–∞ —à–∞—à–∫–∞ –∂–µ“£–¥—ñ!' : '–ê“õ —à–∞—à–∫–∞ –∂–µ“£–¥—ñ!';
    }
}

function resetGame(){
    boardState=[]; selectedPiece=null;
    document.getElementById('winner').classList.add('hidden');
    document.getElementById('board').innerHTML='';
    document.getElementById('question-text').textContent='';
    document.getElementById('answers').innerHTML='';
}
